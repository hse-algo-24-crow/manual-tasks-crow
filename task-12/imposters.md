# Задача коммивояжера (Traveling salesman problem). Метод ветвей и границ.

### Вариант 4:
### Матрица расстояний:
---

|       | **A** | **B** | **C** | **D** | **E** |
| ----- | :---: | :---: | :---: | :---: | :---: |
| **A** | **∞** |  10   |   9   |  15   |   6   |
| **B** |   6   | **∞** |   9   |   9   |  12   |
| **C** |   7   |   9   | **∞** |  12   |   6   |
| **D** |   7   |  10   |  11   | **∞** |   6   |
| **E** |  10   |  15   |   7   |  14   | **∞** |

### Решение
---

Все маршруты начинаются в первом городе 
Все пространство решений n-1!

Ответ это 5 ячеек из матрицы  
Нужно найти Гамильтонов цикл

#### 1. Проведем редукцию матрицы по строкам
---

|       | **A** | **B** | **C** | **D** | **E** | MIN |
| ----- | :---: | :---: | :---: | :---: | :---: | --- |
| **A** | **∞** |  10   |   9   |  15   |   6   | 6   |
| **B** |   6   | **∞** |   9   |   9   |  12   | 6   |
| **C** |   7   |   9   | **∞** |  12   |   6   | 6   |
| **D** |   7   |  10   |  11   | **∞** |   6   | 6   |
| **E** |  10   |  15   |   7   |  14   | **∞** | 7   |
| SUM   |       |       |       |       |       | 31  |

Сумма констант редукции по строкам 31

Матрица после редукции строк:

|       | **A** | **B** | **C** | **D** | **E** |
| ----- | :---: | :---: | :---: | :---: | :---: |
| **A** | **∞** |   4   |   3   |   9   |   0   |
| **B** |   0   | **∞** |   3   |   3   |   6   |
| **C** |   1   |   3   | **∞** |   6   |   0   |
| **D** |   1   |   4   |   7   | **∞** |   0   |
| **E** |   3   |   8   |   0   |   7   | **∞** |

#### 2. Проведем редукцию столбцов матрицы
---

|       | **A** | **B** | **C** | **D** | **E** | SUM |
| ----- | :---: | :---: | :---: | :---: | :---: | --- |
| **A** | **∞** |   4   |   3   |   9   |   0   |     |
| **B** |   0   | **∞** |   3   |   3   |   6   |     |
| **C** |   1   |   3   | **∞** |   6   |   0   |     |
| **D** |   1   |   4   |   7   | **∞** |   0   |     |
| **E** |   3   |   8   |   0   |   7   | **∞** |     |
| MIN   |   0   |   3   |   0   |   3   |   0   | 6   |

Сумма констант редукции по столбцам 6

Матрица после редукции столбцов:

|       | **A** | **B** | **C** | **D** | **E** |
| ----- | :---: | :---: | :---: | :---: | :---: |
| **A** | **∞** |   1   |   3   |   6   |   0   |
| **B** |   0   | **∞** |   3   |   0   |   6   |
| **C** |   1   |   0   | **∞** |   3   |   0   |
| **D** |   1   |   1   |   7   | **∞** |   0   |
| **E** |   3   |   5   |   0   |   4   | **∞** |

#### 3. Оценка длины маршрута
---

Оценка длины маршрута снизу соответствует сумме констант редукции по строкам и по столбцам

31 + 6 = 37

#### 4. Найдем решение задачи с использованием метода ветвей и границ
---

Основная идея алгоритма:

Мы смотрим по каким ребрам можем точно пойти (зарезервировать их), а какие можем исключить (заменить на бесконечность), так чтобы составить минимальный цикл. При постепенном добавлении самое важное следить, чтобы цикл не замкнулся досрочно, поэтому после добавления ребра нужно заменять противоположное ребро на противоположное.

```mermaid

graph TB

    1(#1

    31+6=37)-->|+BD|3(#3

    37+1=38)-->|-EC|4(#4
    38+3=41)
    
    3-->|+EC|5(#5
    38+0=38)-->|-AE|6(#6
    38+1=39)
    5-->|+AE|7(#7
    38+0=38)-->|-CB|8(#8
    38+∞=∞)
    7-->|+CB|9(#9
    38+0=38)-->|+DA|10(#10
    38+0=38)

    1-->|-BD|2(#2

    37+3=40)
   

```

Чтобы определить ребро, по которому будет произведено ветвление из корневого узла рассчитаем штрафы для ребер с нулевой оценкой:

|        | **Штраф** |
| ------ | :-------: |
| **AE** |   **1**   |
| **BA** |     1     |
| **BD** |     3     |
| **CB** |     1     |
| **CE** |     0     |
| **DE** |   **1**   |
| **EC** |   **3**   |

Далее выбираем любое ребро с максимальным штрафом. Я возьму первое, то есть ребро BD

Буду описывать по прядку все ребра из графа.

##### Узел №2
---
Узел №2 с исключением ребра BD имеет оценку 37 + 3 (штраф) = 40

##### Узел №3
---
Для получения оценки узла 3 необходимо рассчитать сумму констант редукции для матрицы с учетом включения ребра BD, для этого в матрице:

- удалим строку B,
- удалим столбец D,
- Заменим на бесконечность значение DB. (это очень важно сделать, чтобы избежать досрочного зацикливания!)

|       | **A** | **B** | **C** | **E** | MIN   |
| ----- | :---: | :---: | :---: | :---: | ----- |
| **A** | **∞** |   1   |   3   |   0   | **0** |
| **C** |   1   |   0   | **∞** |   0   | **0** |
| **D** |   1   | **∞** |   7   |   0   | **0** |
| **E** |   3   |   5   |   0   | **∞** | **0** |
| SUM   |       |       |       |       | **0** |

|       | **A** | **B** | **C** | **E** | SUM |
| ----- | :---: | :---: | :---: | :---: | --- |
| **A** | **∞** |   1   |   3   |   0   |     |
| **C** |   1   |   0   | **∞** |   0   |     |
| **D** |   1   | **∞** |   7   |   0   |     |
| **E** |   3   |   5   |   0   | **∞** |     |
| SUM   |   1   |   0   |   0   |   0   | 1   |

Матрица после редукции:

|       | **A** | **B** | **C** | **E** |
| ----- | :---: | :---: | :---: | :---: |
| **A** | **∞** |   1   |   3   |   0   |
| **C** |   0   |   0   | **∞** |   0   |
| **D** |   0   | **∞** |   7   |   0   |
| **E** |   2   |   5   |   0   | **∞** |

Сумма констант редукции 1

Оценка узла 3 = 37 + 1 (редукция) = 38

Продолжим поиск из узла 3

Нужно пересчитать штрафы, так как матрица изменилась

#### Штрафы

|        | **Штраф** |
| ------ | :-------: |
| **AE** |   **1**   |
| **CA** |   **0**   |
| **CB** |   **1**   |
| **CE** |   **0**   |
| **DA** |   **0**   |
| **DE** |   **1**   |
| **EC** |   **3**   |

Максимальный штраф 3, выберем ребро EC, как ребро с максимальным штрафом.
##### Узел №4
---
Узел №4 с исключением ребра EC имеет оценку 38 + 3 (штраф) = 41
##### Узел №5
---
Для получения оценки узла 5 необходимо рассчитать сумму констант редукции для матрицы с учетом включения ребра EC, для этого в матрице:

- удалим строку E,
- удалим столбец C,
- Заменим на бесконечность значение CE.

|       | **A** | **B** | **E** | MIN |
| ----- | :---: | :---: | :---: | --- |
| **A** | **∞** |   1   |   0   | 0   |
| **C** |   0   |   0   |   ∞   | 0   |
| **D** |   0   | **∞** |   0   | 0   |
| SUM   |       |       |       | 0   |

|       | **A** | **B** | **E** | SUM |
| ----- | :---: | :---: | :---: | --- |
| **A** | **∞** |   1   |   0   |     |
| **C** |   0   |   0   |   ∞   |     |
| **D** |   0   | **∞** |   0   |     |
| MIN   |   0   |   0   |   0   | 0   |

Матрица после редукции:

|       | **A** | **B** | **E** |
| ----- | :---: | :---: | :---: |
| **A** | **∞** |   1   |   0   |
| **C** |   0   |   0   |   ∞   |
| **D** |   0   | **∞** |   0   |

Сумма констант редукции 0

Оценка узла 5 = 37 + 0 (редукция) = 37

Продолжим поиск из узла 5

Нужно пересчитать штрафы, так как матрица изменилась

#### Штрафы

|        | **Штраф** |
| ------ | :-------: |
| **AE** |   **1**   |
| **CA** |   **0**   |
| **CB** |   **1**   |
| **DA** |   **0**   |
| **DE** |   **1**   |

Максимальный штраф 1, выберем ребро AE, как ребро с максимальным штрафом.

##### Узел №6
---
Узел №6 с исключением ребра AE имеет оценку 38 + 1 (штраф) = 39

##### Узел №7
---
Для получения оценки узла 7 необходимо рассчитать сумму констант редукции для матрицы с учетом включения ребра AE, для этого в матрице:

- удалим строку A,
- удалим столбец E,
- Заменим на бесконечность значение EA. (тк у нас уже есть ребро EC, то на бесконечность нужно заменить ребро CA, чтобы избежать ситуации с циклом AECA)

|       | **A** | **B** |
| ----- | :---: | :---: |
| **C** |   ∞   |   0   |
| **D** |   0   | **∞** |

Матрица после редукции:

|       | **A** | **B** |
| ----- | :---: | :---: |
| **C** |   ∞   |   0   |
| **D** |   0   | **∞** |

Сумма констант редукции 0

Оценка узла 7 = 38 + 0 (редукция) = 38

Продолжим поиск из узла 7

Нужно пересчитать штрафы, так как матрица изменилась

#### Штрафы

|        | **Штраф** |
| ------ | :-------: |
| **CB** |   **∞**   |
| **DA** |   **∞**   |

Максимальный штраф ∞, выберем ребро CB, как ребро с максимальным штрафом.
##### Узел №8
---
Узел №8 с исключением ребра CB имеет оценку 38 + ∞ (штраф) = ∞

##### Узел №9
---
Для получения оценки узла 9 необходимо рассчитать сумму констант редукции для матрицы с учетом включения ребра CB, для этого в матрице:

- удалим строку С,
- удалим столбец B,
- Заменим на бесконечность значение BC. (тк у нас уже есть ребро BD, то на бесконечность нужно заменить ребро DC)

|       | **A** |
| ----- | :---: |
| **D** |   0   |

Матрица после редукции:

|       | **A** |
| ----- | :---: |
| **D** |   0   |

Сумма констант редукции 0

Оценка узла 9 = 38 + 0 (редукция) = 38

Продолжим поиск из узла 9

Альтернатив у ребра DA нет

##### Узел №10
---
Ребро DA включается в маршрут, длина которого составляет 38

### Ответ

- Кратчайший маршрут AECBDA.
- Длина маршрута 38.
